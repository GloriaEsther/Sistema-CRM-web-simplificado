{% extends "base.html" %}
{% load static %}
{% load dict_extras %}

{% block title %}Pipeline de Oportunidades{% endblock %}

{% block content %}

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<link rel="stylesheet" href="{% static 'oportunidades/css/estilokanban.css' %}">

<div class="container-fluid mt-3">
  <div class="d-flex justify-content-between">
    <h3>Pipeline de Oportunidades</h3>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalCrear">
      + Crear Oportunidad
    </button>
  </div>

  <div class="kanban-container mt-3">

    {% for etapa in etapas %}
      {% if etapa.nombre_etapa != "Cierre-Perdido" %}

      <div class="kanban-column" data-etapa-id="{{ etapa.idetapa_ventas }}">
        <h6 class="text-center mb-3">{{ etapa.nombre_etapa }}</h6>

        {% with lista=data|dict_get:etapa.nombre_etapa %}
          {% if lista %}
            {% for o in lista %}

              <div class="kanban-card" draggable="true" data-id="{{ o.idoportunidad }}">
                <div class="card-menu dropdown">
                  <i class="bi bi-three-dots-vertical" data-bs-toggle="dropdown"></i>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="abrirConsultar({{ o.idoportunidad }}); return false;">Consultar</a></li>
                    <li><a class="dropdown-item" href="#" onclick="abrirEditar({{ o.idoportunidad }}); return false;">Editar</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="#" onclick="abrirEliminar({{ o.idoportunidad }}); return false;">Eliminar</a></li>
                  </ul>
                </div>

                <div class="card-title">{{ o.nombreoportunidad }}</div>
                <div class="small-muted">{{ o.cliente_oportunidad.nombre }}</div>
                <div class="mt-2 text-success fw-bold">${{ o.valor_estimado }}</div>
              </div>

            {% endfor %}
          {% endif %}
        {% endwith %}

      </div>
      {% endif %}
    {% endfor %}

  </div>
</div>

<!-- Se importan los modales -->
{% include "oportunidades/_crear.html" %}
{% include "oportunidades/_consultar.html" %}
{% include "oportunidades/_editar.html" %}
{% include "oportunidades/_eliminar_confirmar.html" %}

<script id="mensajesData" type="application/json">
  {{ messages_json|safe }}
</script>

<script src="{% static 'js/modal_global.js' %}"></script>
<script src="{% static 'oportunidades/js/oportunidades.js' %}"></script>

{% endblock %}
